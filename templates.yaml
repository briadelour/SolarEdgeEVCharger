# =============================================================================
# SolarEdge EV Charger Template Sensors
# Updated to mimic SolarEdge Smart Home Dashboard
# Version: 1.1.0
# =============================================================================

- sensor:
    # =========================================================================
    # BASIC CHARGER INFORMATION
    # =========================================================================
    
    - name: "EV Charger Status"
      unique_id: ev_charger_status
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {% if charger.chargerStatus == 'CHARGING' %}
          Charging
        {% elif charger.chargerStatus == 'PLUGGED_IN' %}
          Plugged In
        {% elif charger.chargerStatus == 'NOT_CONNECTED' %}
          Not Connected
        {% else %}
          {{ charger.chargerStatus }}
        {% endif %}
      icon: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {% if charger.chargerStatus == 'CHARGING' %}
          mdi:ev-station
        {% elif charger.chargerStatus == 'PLUGGED_IN' %}
          mdi:ev-plug-type2
        {% else %}
          mdi:ev-plug-type2
        {% endif %}

    - name: "EV Charger Power"
      unique_id: ev_charger_power
      unit_of_measurement: "kW"
      device_class: power
      state_class: measurement
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {% if charger.chargerStatus == 'CHARGING' and charger.chargerStatusSubTitle is defined and charger.chargerStatusSubTitle|length > 0 %}
          {{ (charger.chargerStatusSubTitle[0].numericValue / 1000) | round(2) }}
        {% else %}
          0
        {% endif %}

    - name: "EV Session Energy"
      unique_id: ev_session_energy
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {% if charger.sessionActive %}
          {{ (charger.sessionEnergy / 1000) | round(2) }}
        {% else %}
          0
        {% endif %}

    - name: "EV Session Duration"
      unique_id: ev_session_duration
      icon: mdi:timer
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {% if charger.sessionActive %}
          {% set duration_seconds = charger.sessionDuration %}
          {% set hours = (duration_seconds // 3600) | int %}
          {% set minutes = ((duration_seconds % 3600) // 60) | int %}
          {% if hours > 0 %}
            {{ hours }}h {{ minutes }}m
          {% else %}
            {{ minutes }}m
          {% endif %}
        {% else %}
          0m
        {% endif %}

    - name: "EV Connected Vehicle"
      unique_id: ev_connected_vehicle
      icon: mdi:car-electric
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {% if charger.applianceData is defined %}
          {{ charger.applianceData.alias }}
        {% else %}
          Unknown
        {% endif %}

    - name: "EV Charger Mode"
      unique_id: ev_charger_mode
      icon: mdi:cog
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {{ charger.activationMode | title }}

    - name: "EV Connection Status"
      unique_id: ev_connection_status
      icon: mdi:connection
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {{ charger.connectionStatus | replace('_', ' ') | title }}

    - name: "EV Session Distance"
      unique_id: ev_session_distance
      unit_of_measurement: "km"
      icon: mdi:map-marker-distance
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {% if charger.sessionActive %}
          {{ charger.sessionDistance | round(1) }}
        {% else %}
          0
        {% endif %}

    - name: "EV Session Distance (Miles)"
      unique_id: ev_session_distance_mi
      unit_of_measurement: "mi"
      icon: mdi:map-marker-distance
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {% if charger.sessionActive %}
          {{ (charger.sessionDistance * 0.621371) | round(1) }}
        {% else %}
          0
        {% endif %}

    # =========================================================================
    # EXCESS SOLAR MONITORING (NEW)
    # =========================================================================
    
    - name: "EV Excess Solar Status"
      unique_id: ev_excess_solar_status
      icon: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {% if charger.excessPV == -1 %}
          mdi:solar-power
        {% else %}
          mdi:solar-power-variant-outline
        {% endif %}
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {% if charger.excessPV == -1 %}
          Enabled
        {% elif charger.excessPV == -2 %}
          Disabled
        {% else %}
          Unknown
        {% endif %}

    - name: "EV Session Solar Usage"
      unique_id: ev_session_solar_usage
      icon: mdi:solar-panel
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {% if charger.excessPV == -1 %}
          {% if charger.sessionSolarUsage != 'NONE' %}
            {{ charger.sessionSolarUsage | replace('_', ' ') | title }}
          {% else %}
            No Solar Usage
          {% endif %}
        {% else %}
          Excess Solar Disabled
        {% endif %}

    # =========================================================================
    # SCHEDULE MONITORING (NEW)
    # =========================================================================
    
    - name: "EV Charging Schedules"
      unique_id: ev_charging_schedules
      icon: mdi:calendar-clock
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {% set enabled_schedules = charger.deviceTriggers | selectattr('enable', 'equalto', true) | list %}
        {% if enabled_schedules | length > 0 %}
          {{ enabled_schedules | length }} Schedule(s) Active
        {% else %}
          No Schedules
        {% endif %}
      attributes:
        schedules: >
          {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
          {% set enabled_schedules = charger.deviceTriggers | selectattr('enable', 'equalto', true) | list %}
          {% set schedule_list = [] %}
          {% for schedule in enabled_schedules %}
            {% set start_hour = (schedule.startTime // 60) | int %}
            {% set start_min = (schedule.startTime % 60) | int %}
            {% set end_hour = (schedule.endTime // 60) | int %}
            {% set end_min = (schedule.endTime % 60) | int %}
            {% set time_range = '%02d:%02d - %02d:%02d' | format(start_hour, start_min, end_hour, end_min) %}
            {% set days_abbrev = [] %}
            {% if 'MONDAY' in schedule.scheduledDays %}{% set days_abbrev = days_abbrev + ['Mon'] %}{% endif %}
            {% if 'TUESDAY' in schedule.scheduledDays %}{% set days_abbrev = days_abbrev + ['Tue'] %}{% endif %}
            {% if 'WEDNESDAY' in schedule.scheduledDays %}{% set days_abbrev = days_abbrev + ['Wed'] %}{% endif %}
            {% if 'THURSDAY' in schedule.scheduledDays %}{% set days_abbrev = days_abbrev + ['Thu'] %}{% endif %}
            {% if 'FRIDAY' in schedule.scheduledDays %}{% set days_abbrev = days_abbrev + ['Fri'] %}{% endif %}
            {% if 'SATURDAY' in schedule.scheduledDays %}{% set days_abbrev = days_abbrev + ['Sat'] %}{% endif %}
            {% if 'SUNDAY' in schedule.scheduledDays %}{% set days_abbrev = days_abbrev + ['Sun'] %}{% endif %}
            {% set days_str = days_abbrev | join(', ') %}
            {% set schedule_list = schedule_list + [time_range + ' (' + days_str + ')'] %}
          {% endfor %}
          {{ schedule_list }}

    - name: "EV Next Scheduled Charge"
      unique_id: ev_next_scheduled_charge
      icon: mdi:clock-outline
      device_class: timestamp
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {% set enabled_schedules = charger.deviceTriggers | selectattr('enable', 'equalto', true) | list %}
        {% if enabled_schedules | length > 0 and charger.chargerStatus != 'CHARGING' %}
          {% if charger.scheduleInfo is defined and charger.scheduleInfo.startDate is defined %}
            {{ (charger.scheduleInfo.startDate / 1000) | timestamp_local }}
          {% else %}
            {% set now = now() %}
            {% set current_day = now.weekday() %}
            {% set current_time = now.hour * 60 + now.minute %}
            {% set days_map = {'MONDAY': 0, 'TUESDAY': 1, 'WEDNESDAY': 2, 'THURSDAY': 3, 'FRIDAY': 4, 'SATURDAY': 5, 'SUNDAY': 6} %}
            {% set next_schedule = namespace(time=none, days_ahead=999) %}
            {% for schedule in enabled_schedules %}
              {% for day in schedule.scheduledDays %}
                {% set schedule_day = days_map[day] %}
                {% set days_until = (schedule_day - current_day) % 7 %}
                {% if days_until == 0 and schedule.startTime > current_time %}
                  {% if days_until < next_schedule.days_ahead or (days_until == next_schedule.days_ahead and schedule.startTime < next_schedule.time) %}
                    {% set next_schedule.time = schedule.startTime %}
                    {% set next_schedule.days_ahead = days_until %}
                  {% endif %}
                {% elif days_until > 0 %}
                  {% if days_until < next_schedule.days_ahead or (days_until == next_schedule.days_ahead and schedule.startTime < next_schedule.time) %}
                    {% set next_schedule.time = schedule.startTime %}
                    {% set next_schedule.days_ahead = days_until %}
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% endfor %}
            {% if next_schedule.time is not none %}
              {% set next_date = now + timedelta(days=next_schedule.days_ahead) %}
              {% set next_hour = (next_schedule.time // 60) | int %}
              {% set next_min = (next_schedule.time % 60) | int %}
              {{ next_date.replace(hour=next_hour, minute=next_min, second=0, microsecond=0).isoformat() }}
            {% else %}
              unavailable
            {% endif %}
          {% endif %}
        {% else %}
          unavailable
        {% endif %}

# =============================================================================
# BINARY SENSORS
# =============================================================================

- binary_sensor:
    - name: "EV Charger Connected"
      unique_id: ev_charger_connected
      device_class: plug
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {{ charger.connectionStatus in ['CONNECTED', 'CHARGING'] }}

    - name: "EV Charger Charging"
      unique_id: ev_charger_charging
      device_class: battery_charging
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {{ charger.chargerStatus == 'CHARGING' }}

    - name: "EV Charge Schedule Enabled"
      unique_id: ev_charge_schedule_enabled
      device_class: running
      icon: mdi:calendar-check
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {% set enabled_schedules = charger.deviceTriggers | selectattr('enable', 'equalto', true) | list %}
        {{ enabled_schedules | length > 0 }}

    - name: "EV Excess Solar Enabled"
      unique_id: ev_excess_solar_enabled
      device_class: running
      icon: mdi:solar-power
      state: >
        {% set charger = state_attr('sensor.solaredge_ev_charger_raw', 'devicesByType')['EV_CHARGER'][0] %}
        {{ charger.excessPV == -1 }}
